"use strict";(self.webpackChunkjest_website=self.webpackChunkjest_website||[]).push([[3430],{5346:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>d,contentTitle:()=>r,default:()=>m,frontMatter:()=>i,metadata:()=>c,toc:()=>l});var t=n(4246),o=n(1670);const i={id:"ecmascript-modules",title:"ECMAScript \u30e2\u30b8\u30e5\u30fc\u30eb"},r=void 0,c={unversionedId:"ecmascript-modules",id:"version-29.5/ecmascript-modules",title:"ECMAScript \u30e2\u30b8\u30e5\u30fc\u30eb",description:"Jest \u306f ECMAScript \u30e2\u30b8\u30e5\u30fc\u30eb (ESM) \u306e\u5b9f\u9a13\u7684\u306a\u30b5\u30dd\u30fc\u30c8\u3092\u63d0\u4f9b\u3057\u3066\u3044\u307e\u3059\u3002",source:"@site/i18n/ja/docusaurus-plugin-content-docs/version-29.5/ECMAScriptModules.md",sourceDirName:".",slug:"/ecmascript-modules",permalink:"/ja/docs/29.5/ecmascript-modules",draft:!1,unlisted:!1,editUrl:"https://crowdin.com/project/jest-v2/ja",tags:[],version:"29.5",frontMatter:{id:"ecmascript-modules",title:"ECMAScript \u30e2\u30b8\u30e5\u30fc\u30eb"},sidebar:"docs",previous:{title:"\u30e2\u30b8\u30e5\u30fc\u30eb\u30e2\u30c3\u30af\u306e\u30d0\u30a4\u30d1\u30b9",permalink:"/ja/docs/29.5/bypassing-module-mocks"},next:{title:"Using with webpack",permalink:"/ja/docs/29.5/webpack"}},d={},l=[{value:"ESM \u3068 CommonJS \u306e\u9055\u3044",id:"esm-\u3068-commonjs-\u306e\u9055\u3044",level:2},{value:"ESM \u306b\u304a\u3051\u308b\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30e2\u30c3\u30af",id:"esm-\u306b\u304a\u3051\u308b\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30e2\u30c3\u30af",level:2}];function a(e){const s=Object.assign({admonition:"admonition",p:"p",strong:"strong",a:"a",code:"code",ol:"ol",li:"li",em:"em",h2:"h2",pre:"pre"},(0,o.ah)(),e.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(s.admonition,{type:"caution",children:[(0,t.jsxs)(s.p,{children:["Jest \u306f ECMAScript \u30e2\u30b8\u30e5\u30fc\u30eb (ESM) \u306e",(0,t.jsx)(s.strong,{children:"\u5b9f\u9a13\u7684"}),"\u306a\u30b5\u30dd\u30fc\u30c8\u3092\u63d0\u4f9b\u3057\u3066\u3044\u307e\u3059\u3002"]}),(0,t.jsxs)(s.p,{children:["\u5b9f\u88c5\u306b\u306f\u30d0\u30b0\u3084\u6a5f\u80fd\u4e0d\u8db3\u304c\u3042\u308b\u53ef\u80fd\u6027\u304c\u3042\u308a\u307e\u3059\u3002 For the latest status check out the ",(0,t.jsx)(s.a,{href:"https://github.com/jestjs/jest/issues/9430",children:"issue"})," and the ",(0,t.jsx)(s.a,{href:"https://github.com/jestjs/jest/labels/ES%20Modules",children:"label"})," on the issue tracker."]}),(0,t.jsxs)(s.p,{children:["\u307e\u305f\u3001Jest \u304c ESM \u30b5\u30dd\u30fc\u30c8\u3092\u5b9f\u88c5\u3059\u308b\u306e\u306b\u4f7f\u7528\u3057\u3066\u3044\u308b API \u306f\u3001\u307e\u3060 ",(0,t.jsx)(s.a,{href:"https://nodejs.org/api/vm.html#vm_class_vm_module",children:"Node \u306b\u3088\u308a\u5b9f\u9a13\u7684\u3067\u3042\u308b\u3068\u3055\u308c\u3066\u3044\u308b"}),"\u3053\u3068\u306b\u6ce8\u610f\u3057\u3066\u304f\u3060\u3055\u3044 (\u30d0\u30fc\u30b8\u30e7\u30f3 ",(0,t.jsx)(s.code,{children:"18.8.0"})," \u6642\u70b9)\u3002"]})]}),"\n",(0,t.jsx)(s.p,{children:"With the warnings out of the way, this is how you activate ESM support in your tests."}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"transform: {}"})," \u3092\u6e21\u3059\u3053\u3068\u3067\u3001",(0,t.jsx)(s.a,{href:"/ja/docs/29.5/configuration#transform-objectstring-pathtotransformer--pathtotransformer-object",children:"\u30b3\u30fc\u30c9\u5909\u63db"}),"\u3092\u7121\u52b9\u306b\u3059\u308b\u304b\u3001\u30c7\u30d5\u30a9\u30eb\u30c8\u306e CommonJS (CJS) \u3067\u306f\u306a\u304f ESM \u3092\u51fa\u529b\u3059\u308b\u3088\u3046\u306b\u5909\u63db\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"node"})," \u3092 ",(0,t.jsx)(s.code,{children:"--experimental-vm-modules"})," \u30aa\u30d7\u30b7\u30e7\u30f3\u3092\u4ed8\u3051\u3066\u5b9f\u884c\u3057\u307e\u3059\u3002\u4f8b: ",(0,t.jsx)(s.code,{children:"node --experimental-vm-modules node_modules/jest/bin/jest.js"})," \u307e\u305f\u306f ",(0,t.jsx)(s.code,{children:"NODE_OPTIONS=--experimal-vm-modules npx jest"})," \u306a\u3069\u3002"]}),"\n",(0,t.jsxs)(s.p,{children:["On Windows, you can use ",(0,t.jsx)(s.a,{href:"https://github.com/kentcdodds/cross-env",children:(0,t.jsx)(s.code,{children:"cross-env"})})," to be able to set environment variables."]}),"\n",(0,t.jsxs)(s.p,{children:["If you use Yarn, you can use ",(0,t.jsx)(s.code,{children:"yarn node --experimental-vm-modules $(yarn bin jest)"}),". This command will also work if you use ",(0,t.jsx)(s.a,{href:"https://yarnpkg.com/features/pnp",children:"Yarn Plug'n'Play"}),"."]}),"\n",(0,t.jsxs)(s.p,{children:["If your codebase includes ESM imports from ",(0,t.jsx)(s.code,{children:"*.wasm"})," files, you do ",(0,t.jsx)(s.em,{children:"not"})," need to pass ",(0,t.jsx)(s.code,{children:"--experimental-wasm-modules"})," to ",(0,t.jsx)(s.code,{children:"node"}),". Current implementation of WebAssembly imports in Jest relies on experimental VM modules, however, this may change in the future."]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["\u305d\u308c\u4ee5\u5916\u306f ",(0,t.jsx)(s.code,{children:"node"})," \u304c\u300cESM \u30e2\u30fc\u30c9\u300d\u3092\u6709\u52b9\u306b\u3059\u308b\u30ed\u30b8\u30c3\u30af (\u305f\u3068\u3048\u3070\u3001",(0,t.jsx)(s.code,{children:"package.json"})," \u306e ",(0,t.jsx)(s.code,{children:"type"})," \u3084\u3001",(0,t.jsx)(s.code,{children:".mjs"})," \u30d5\u30a1\u30a4\u30eb\u3067\u3042\u308b\u304b\u3092\u78ba\u8a8d\u3059\u308b\u306a\u3069) \u306b\u5f93\u3046\u3088\u3046\u306b\u52aa\u3081\u3066\u3044\u307e\u3059\u3002\u8a73\u7d30\u306b\u3064\u3044\u3066\u306f\u3001",(0,t.jsx)(s.a,{href:"https://nodejs.org/api/esm.html#esm_enabling",children:"node \u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8"}),"\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["\n",(0,t.jsxs)(s.p,{children:["\u4ed6\u306e\u30d5\u30a1\u30a4\u30eb\u62e1\u5f35\u5b50 (",(0,t.jsx)(s.code,{children:".jsx"})," \u3084 ",(0,t.jsx)(s.code,{children:".ts"})," \u306a\u3069) \u3092 ESM \u3068\u3057\u3066\u6271\u3044\u305f\u3044\u5834\u5408\u306f\u3001",(0,t.jsxs)(s.a,{href:"/ja/docs/29.5/configuration#extensionstotreatasesm-arraystring",children:[(0,t.jsx)(s.code,{children:"extensionsToTreatAsEsm"})," \u30aa\u30d7\u30b7\u30e7\u30f3"]})," \u3092\u4f7f\u7528\u3057\u3066\u304f\u3060\u3055\u3044\u3002"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"esm-\u3068-commonjs-\u306e\u9055\u3044",children:"ESM \u3068 CommonJS \u306e\u9055\u3044"}),"\n",(0,t.jsxs)(s.p,{children:["Most of the differences are explained in ",(0,t.jsx)(s.a,{href:"https://nodejs.org/api/esm.html#esm_differences_between_es_modules_and_commonjs",children:"Node's documentation"}),", but in addition to the things mentioned there, Jest injects a special variable into all executed files - the ",(0,t.jsxs)(s.a,{href:"/ja/docs/29.5/jest-object",children:[(0,t.jsx)(s.code,{children:"jest"})," object"]}),". To access this object in ESM, you need to import it from the ",(0,t.jsx)(s.code,{children:"@jest/globals"})," module or use ",(0,t.jsx)(s.code,{children:"import.meta"}),"."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-js",children:"import {jest} from '@jest/globals';\n\njest.useFakeTimers();\n\n// etc.\n\n// \u307e\u305f\u306f\nimport.meta.jest.useFakeTimers();\n\n// jest === import.meta.jest => true\n"})}),"\n",(0,t.jsx)(s.h2,{id:"esm-\u306b\u304a\u3051\u308b\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30e2\u30c3\u30af",children:"ESM \u306b\u304a\u3051\u308b\u30e2\u30b8\u30e5\u30fc\u30eb\u306e\u30e2\u30c3\u30af"}),"\n",(0,t.jsxs)(s.p,{children:["Since ESM evaluates static ",(0,t.jsx)(s.code,{children:"import"})," statements before looking at the code, the hoisting of ",(0,t.jsx)(s.code,{children:"jest.mock"})," calls that happens in CJS won't work for ESM. To mock modules in ESM, you need to use ",(0,t.jsx)(s.code,{children:"require"})," or dynamic ",(0,t.jsx)(s.code,{children:"import()"})," after ",(0,t.jsx)(s.code,{children:"jest.mock"})," calls to load the mocked modules - the same applies to modules which load the mocked modules."]}),"\n",(0,t.jsxs)(s.p,{children:["ESM mocking is supported through ",(0,t.jsx)(s.code,{children:"jest.unstable_mockModule"}),". As the name suggests, this API is still work in progress, please follow ",(0,t.jsx)(s.a,{href:"https://github.com/jestjs/jest/issues/10025",children:"this issue"})," for updates."]}),"\n",(0,t.jsxs)(s.p,{children:["The usage of ",(0,t.jsx)(s.code,{children:"jest.unstable_mockModule"})," is essentially the same as ",(0,t.jsx)(s.code,{children:"jest.mock"})," with two differences: the factory function is required and it can be sync or async:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-js",children:"import {jest} from '@jest/globals';\n\njest.unstable_mockModule('node:child_process', () => ({\n  execSync: jest.fn(),\n  // etc.\n}));\n\nconst {execSync} = await import('node:child_process');\n\n// etc.\n"})}),"\n",(0,t.jsxs)(s.p,{children:["For mocking CJS modules, you should continue to use ",(0,t.jsx)(s.code,{children:"jest.mock"}),". See the example below:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-js",metastring:'title="main.cjs"',children:"const {BrowserWindow, app} = require('electron');\n\n// etc.\n\nmodule.exports = {example};\n"})}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-js",metastring:'title="main.test.cjs"',children:"import {createRequire} from 'node:module';\nimport {jest} from '@jest/globals';\n\nconst require = createRequire(import.meta.url);\n\njest.mock('electron', () => ({\n  app: {\n    on: jest.fn(),\n    whenReady: jest.fn(() => Promise.resolve()),\n  },\n  BrowserWindow: jest.fn().mockImplementation(() => ({\n    // \u90e8\u5206\u7684\u306a\u30e2\u30c3\u30af\n  })),\n}));\n\nconst {BrowserWindow} = require('electron');\nconst exported = require('./main.cjs');\n\n// \u307e\u305f\u306f\nconst {BrowserWindow} = (await import('electron')).default;\nconst exported = await import('./main.cjs');\n\n// etc.\n"})})]})}const m=function(e={}){const{wrapper:s}=Object.assign({},(0,o.ah)(),e.components);return s?(0,t.jsx)(s,Object.assign({},e,{children:(0,t.jsx)(a,e)})):a(e)}},1670:(e,s,n)=>{n.d(s,{Zo:()=>c,ah:()=>i});var t=n(7378);const o=t.createContext({});function i(e){const s=t.useContext(o);return t.useMemo((()=>"function"==typeof e?e(s):{...s,...e}),[s,e])}const r={};function c({components:e,children:s,disableParentContext:n}){let c;return c=n?"function"==typeof e?e({}):e||r:i(e),t.createElement(o.Provider,{value:c},s)}}}]);